{% extends "layout/base.html" %}

{% block title %}Watchlists - FluxScan{% endblock %}

{% block content %}
<div class="container mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Watchlists</h1>
        <div class="flex gap-2">
            <button class="btn btn-primary" onclick="newWatchlistModal.showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                New Watchlist
            </button>
            <button class="btn btn-secondary" onclick="importModal.showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-9.707a1 1 0 011.414 0L9 8.586V3a1 1 0 112 0v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Import
            </button>
        </div>
    </div>

    <!-- Watchlists Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for watchlist in watchlists %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">{{ watchlist.name }}</h2>
                <p class="text-sm opacity-70">Default: {{ watchlist.exchange }}</p>
                <p>{{ watchlist.description or "No description" }}</p>

                <div class="stats shadow mt-2">
                    <div class="stat px-4 py-2">
                        <div class="stat-title text-xs">Symbols</div>
                        <div class="stat-value text-lg">{{ watchlist.symbol_count() }}</div>
                    </div>
                </div>

                <!-- Symbol preview -->
                <div class="flex flex-wrap gap-1 mt-2">
                    {% for item in watchlist.get_symbols()[:3] %}
                    <span class="badge badge-sm" title="{{ item.exchange }}">{{ item.symbol }}:{{ item.exchange }}</span>
                    {% endfor %}
                    {% if watchlist.symbol_count() > 3 %}
                    <span class="badge badge-sm badge-ghost">+{{ watchlist.symbol_count() - 3 }} more</span>
                    {% endif %}
                </div>

                <div class="card-actions justify-end mt-4">
                    <button class="btn btn-ghost btn-sm" onclick="viewWatchlist({{ watchlist.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        View
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="editWatchlist({{ watchlist.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                        Edit
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="exportWatchlist({{ watchlist.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Export
                    </button>
                    <button class="btn btn-error btn-sm" onclick="deleteWatchlist({{ watchlist.id }}, '{{ watchlist.name }}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-span-full text-center py-8">
            <p class="text-lg opacity-70 mb-4">No watchlists found</p>
            <button class="btn btn-primary" onclick="newWatchlistModal.showModal()">Create Your First Watchlist</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Watchlist Modal -->
<dialog id="editWatchlistModal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
        <h3 class="font-bold text-lg mb-4">Edit Watchlist</h3>
        <div class="space-y-4">
            <input type="hidden" id="edit-watchlist-id" />

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Watchlist Name</span>
                </label>
                <input type="text" id="edit-watchlist-name" class="input input-bordered" />
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Description</span>
                </label>
                <textarea id="edit-watchlist-desc" class="textarea textarea-bordered" rows="2"></textarea>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Default Exchange</span>
                </label>
                <select id="edit-default-exchange" class="select select-bordered">
                    <option value="NSE">NSE - National Stock Exchange</option>
                    <option value="BSE">BSE - Bombay Stock Exchange</option>
                    <option value="NFO">NFO - NSE Futures & Options</option>
                    <option value="BFO">BFO - BSE Futures & Options</option>
                    <option value="CDS">CDS - Currency Derivatives</option>
                    <option value="BCD">BCD - BSE Currency Derivatives</option>
                    <option value="MCX">MCX - Multi Commodity Exchange</option>
                </select>
            </div>

            <div class="divider">Symbols</div>

            <div class="flex gap-2 mb-2">
                <input type="text" id="edit-add-symbol" placeholder="Symbol" class="input input-bordered input-sm flex-1" />
                <select id="edit-add-exchange" class="select select-bordered select-sm">
                    <option value="NSE">NSE</option>
                    <option value="BSE">BSE</option>
                    <option value="NFO">NFO</option>
                    <option value="BFO">BFO</option>
                    <option value="CDS">CDS</option>
                    <option value="BCD">BCD</option>
                    <option value="MCX">MCX</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="addSymbolToEdit()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add
                </button>
            </div>

            <div class="max-h-64 overflow-y-auto border rounded-lg p-2">
                <div id="edit-symbols-list" class="flex flex-wrap gap-2">
                    <!-- Symbols will be added here -->
                </div>
            </div>

            <div class="divider">Bulk Upload</div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Paste symbols (Format: SYMBOL,EXCHANGE or just SYMBOL)</span>
                    <span class="label-text-alt">One per line. Exchange defaults to NSE if not specified.</span>
                </label>
                <textarea id="edit-bulk-symbols" class="textarea textarea-bordered" rows="5"
                          placeholder="RELIANCE,NSE
TCS
INFOSYS,BSE
GOLD,MCX"></textarea>
                <button class="btn btn-outline btn-sm mt-2" onclick="parseBulkSymbols()">Parse & Add Symbols</button>
            </div>
        </div>

        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <button class="btn btn-primary" onclick="saveEditedWatchlist()">Save Changes</button>
        </div>
    </div>
</dialog>

<!-- New Watchlist Modal -->
<dialog id="newWatchlistModal" class="modal">
    <div class="modal-box w-11/12 max-w-3xl">
        <h3 class="font-bold text-lg">Create New Watchlist</h3>
        <div class="py-4">
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Watchlist Name</span>
                </label>
                <input type="text" id="new-watchlist-name" placeholder="My Watchlist" class="input input-bordered w-full" />
            </div>
            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Description</span>
                </label>
                <textarea id="new-watchlist-description" class="textarea textarea-bordered" placeholder="Description"></textarea>
            </div>
            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Default Exchange</span>
                    <span class="label-text-alt">Used when exchange not specified</span>
                </label>
                <select id="new-watchlist-exchange" class="select select-bordered">
                    <option value="NSE" selected>NSE - National Stock Exchange</option>
                    <option value="BSE">BSE - Bombay Stock Exchange</option>
                    <option value="NFO">NFO - NSE Futures & Options</option>
                    <option value="BFO">BFO - BSE Futures & Options</option>
                    <option value="CDS">CDS - Currency Derivatives</option>
                    <option value="BCD">BCD - BSE Currency Derivatives</option>
                    <option value="MCX">MCX - Multi Commodity Exchange</option>
                </select>
            </div>
            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Symbols (Format: SYMBOL,EXCHANGE or just SYMBOL)</span>
                    <span class="label-text-alt">One per line. Exchange defaults to selected above if not specified.</span>
                </label>
                <textarea id="new-watchlist-symbols" class="textarea textarea-bordered h-32"
                          placeholder="RELIANCE,NSE
TCS
INFOSYS,BSE
HDFCBANK
GOLD,MCX"></textarea>
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <button class="btn btn-primary" onclick="createWatchlist()">Create</button>
        </div>
    </div>
</dialog>

<!-- Import Modal -->
<dialog id="importModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Import Watchlist</h3>
        <div class="py-4">
            <div class="tabs tabs-boxed">
                <a class="tab tab-active" onclick="showImportTab('file')">From File</a>
                <a class="tab" onclick="showImportTab('predefined')">Predefined</a>
            </div>

            <div id="import-file-tab" class="mt-4">
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Watchlist Name</span>
                    </label>
                    <input type="text" id="import-name" placeholder="Imported List" class="input input-bordered w-full" />
                </div>
                <div class="form-control w-full mt-4">
                    <label class="label">
                        <span class="label-text">Upload CSV File (Format: SYMBOL,EXCHANGE)</span>
                    </label>
                    <input type="file" id="import-file" class="file-input file-input-bordered w-full" accept=".csv,.txt" />
                </div>
            </div>

            <div id="import-predefined-tab" class="mt-4 hidden">
                <div class="grid grid-cols-1 gap-2">
                    <button class="btn btn-outline w-full" onclick="importPredefined('NIFTY50')">NIFTY 50</button>
                    <button class="btn btn-outline w-full" onclick="importPredefined('NIFTYBANK')">NIFTY Bank</button>
                    <button class="btn btn-outline w-full" onclick="importPredefined('NIFTYIT')">NIFTY IT</button>
                    <button class="btn btn-outline w-full" onclick="importPredefined('SENSEX')">SENSEX 30</button>
                    <button class="btn btn-outline w-full" onclick="importPredefined('MIDCAP')">NIFTY Midcap 100</button>
                </div>
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <button class="btn btn-primary" onclick="importWatchlist()">Import</button>
        </div>
    </div>
</dialog>

<!-- View Watchlist Modal -->
<dialog id="viewWatchlistModal" class="modal">
    <div class="modal-box w-11/12 max-w-3xl">
        <h3 class="font-bold text-lg" id="view-watchlist-title">Watchlist</h3>
        <div class="py-4">
            <div id="watchlist-symbols" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                <!-- Symbols will be loaded here -->
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

<script>
let editingSymbols = [];

function showImportTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
    event.target.classList.add('tab-active');

    if (tab === 'file') {
        document.getElementById('import-file-tab').classList.remove('hidden');
        document.getElementById('import-predefined-tab').classList.add('hidden');
    } else {
        document.getElementById('import-file-tab').classList.add('hidden');
        document.getElementById('import-predefined-tab').classList.remove('hidden');
    }
}

async function createWatchlist() {
    const name = document.getElementById('new-watchlist-name').value;
    const description = document.getElementById('new-watchlist-description').value;
    const exchange = document.getElementById('new-watchlist-exchange').value;
    const symbolsText = document.getElementById('new-watchlist-symbols').value;

    if (!name) {
        FluxScan.showToast('Please enter a watchlist name', 'error');
        return;
    }

    // Parse symbols with exchange format
    const symbols = [];
    const lines = symbolsText.split('\n').map(l => l.trim()).filter(l => l);

    for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts[0]) {
            const symbol = {
                symbol: parts[0].toUpperCase(),
                exchange: parts[1] ? parts[1].toUpperCase() : exchange
            };
            symbols.push(symbol);
        }
    }

    try {
        const response = await fetch('/watchlists/api/watchlists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: description,
                exchange: exchange,
                symbols: symbols
            })
        });

        if (response.ok) {
            FluxScan.showToast('Watchlist created successfully', 'success');
            newWatchlistModal.close();
            location.reload();
        } else {
            const error = await response.json();
            FluxScan.showToast(error.error || 'Failed to create watchlist', 'error');
        }
    } catch (error) {
        FluxScan.showToast('Failed to create watchlist', 'error');
    }
}

async function viewWatchlist(id) {
    try {
        const response = await fetch(`/watchlists/api/watchlists/${id}`);
        const watchlist = await response.json();

        document.getElementById('view-watchlist-title').textContent = watchlist.name;
        const symbolsDiv = document.getElementById('watchlist-symbols');

        symbolsDiv.innerHTML = watchlist.symbols.map(item =>
            `<div class="badge badge-primary badge-lg p-3">
                <span class="font-bold">${item.symbol}</span>
                <span class="ml-1 opacity-75">:${item.exchange}</span>
            </div>`
        ).join('');

        viewWatchlistModal.showModal();
    } catch (error) {
        FluxScan.showToast('Failed to load watchlist', 'error');
    }
}

async function editWatchlist(id) {
    try {
        const response = await fetch(`/watchlists/api/watchlists/${id}`);
        const watchlist = await response.json();

        document.getElementById('edit-watchlist-id').value = id;
        document.getElementById('edit-watchlist-name').value = watchlist.name;
        document.getElementById('edit-watchlist-desc').value = watchlist.description || '';
        document.getElementById('edit-default-exchange').value = watchlist.exchange;

        editingSymbols = watchlist.symbols || [];
        renderEditSymbols();

        editWatchlistModal.showModal();
    } catch (error) {
        FluxScan.showToast('Failed to load watchlist', 'error');
    }
}

function renderEditSymbols() {
    const container = document.getElementById('edit-symbols-list');
    container.innerHTML = editingSymbols.map((item, index) => `
        <div class="badge badge-lg gap-2">
            <span>${item.symbol}:${item.exchange}</span>
            <button onclick="removeEditSymbol(${index})" class="btn btn-ghost btn-xs">×</button>
        </div>
    `).join('');
}

function addSymbolToEdit() {
    const symbol = document.getElementById('edit-add-symbol').value.trim().toUpperCase();
    const exchange = document.getElementById('edit-add-exchange').value;

    if (!symbol) {
        FluxScan.showToast('Please enter a symbol', 'error');
        return;
    }

    // Check if already exists
    const exists = editingSymbols.some(s => s.symbol === symbol && s.exchange === exchange);
    if (exists) {
        FluxScan.showToast('Symbol already exists', 'warning');
        return;
    }

    editingSymbols.push({ symbol, exchange });
    renderEditSymbols();
    document.getElementById('edit-add-symbol').value = '';
}

function removeEditSymbol(index) {
    editingSymbols.splice(index, 1);
    renderEditSymbols();
}

function parseBulkSymbols() {
    const text = document.getElementById('edit-bulk-symbols').value;
    const defaultExchange = document.getElementById('edit-default-exchange').value;

    const lines = text.split('\n').map(l => l.trim()).filter(l => l);

    for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts[0]) {
            const symbol = parts[0].toUpperCase();
            const exchange = parts[1] ? parts[1].toUpperCase() : defaultExchange;

            // Check if already exists
            const exists = editingSymbols.some(s => s.symbol === symbol && s.exchange === exchange);
            if (!exists) {
                editingSymbols.push({ symbol, exchange });
            }
        }
    }

    renderEditSymbols();
    document.getElementById('edit-bulk-symbols').value = '';
    FluxScan.showToast('Symbols parsed and added', 'success');
}

async function saveEditedWatchlist() {
    const id = document.getElementById('edit-watchlist-id').value;
    const name = document.getElementById('edit-watchlist-name').value;
    const description = document.getElementById('edit-watchlist-desc').value;
    const exchange = document.getElementById('edit-default-exchange').value;

    if (!name) {
        FluxScan.showToast('Please enter a watchlist name', 'error');
        return;
    }

    try {
        const response = await fetch(`/watchlists/api/watchlists/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                description: description,
                exchange: exchange,
                symbols: editingSymbols
            })
        });

        if (response.ok) {
            FluxScan.showToast('Watchlist updated successfully', 'success');
            editWatchlistModal.close();
            location.reload();
        } else {
            const error = await response.json();
            FluxScan.showToast(error.error || 'Failed to update watchlist', 'error');
        }
    } catch (error) {
        FluxScan.showToast('Failed to update watchlist', 'error');
    }
}

async function deleteWatchlist(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/watchlists/api/watchlists/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            FluxScan.showToast('Watchlist deleted successfully', 'success');
            location.reload();
        } else {
            FluxScan.showToast('Failed to delete watchlist', 'error');
        }
    } catch (error) {
        FluxScan.showToast('Failed to delete watchlist', 'error');
    }
}

async function exportWatchlist(id) {
    try {
        window.location.href = `/watchlists/api/watchlists/${id}/export`;
    } catch (error) {
        FluxScan.showToast('Failed to export watchlist', 'error');
    }
}

async function importWatchlist() {
    const fileInput = document.getElementById('import-file');
    const nameInput = document.getElementById('import-name');

    if (!fileInput.files[0]) {
        FluxScan.showToast('Please select a file', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('name', nameInput.value || 'Imported Watchlist');

    try {
        const response = await fetch('/watchlists/api/watchlists/import', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            FluxScan.showToast('Watchlist imported successfully', 'success');
            importModal.close();
            location.reload();
        } else {
            const error = await response.json();
            FluxScan.showToast(error.error || 'Failed to import watchlist', 'error');
        }
    } catch (error) {
        FluxScan.showToast('Failed to import watchlist', 'error');
    }
}

async function importPredefined(indexName) {
    const predefinedLists = {
        'NIFTY50': {
            name: 'NIFTY 50',
            description: 'Top 50 companies from NSE',
            symbols: [
                {symbol: 'RELIANCE', exchange: 'NSE'},
                {symbol: 'TCS', exchange: 'NSE'},
                {symbol: 'HDFCBANK', exchange: 'NSE'},
                {symbol: 'ICICIBANK', exchange: 'NSE'},
                {symbol: 'INFY', exchange: 'NSE'},
                {symbol: 'HINDUNILVR', exchange: 'NSE'},
                {symbol: 'ITC', exchange: 'NSE'},
                {symbol: 'SBIN', exchange: 'NSE'},
                {symbol: 'BHARTIARTL', exchange: 'NSE'},
                {symbol: 'KOTAKBANK', exchange: 'NSE'},
                {symbol: 'LT', exchange: 'NSE'},
                {symbol: 'AXISBANK', exchange: 'NSE'},
                {symbol: 'WIPRO', exchange: 'NSE'},
                {symbol: 'ASIANPAINT', exchange: 'NSE'},
                {symbol: 'MARUTI', exchange: 'NSE'}
            ]
        },
        'NIFTYBANK': {
            name: 'NIFTY Bank',
            description: 'Banking sector stocks',
            symbols: [
                {symbol: 'HDFCBANK', exchange: 'NSE'},
                {symbol: 'ICICIBANK', exchange: 'NSE'},
                {symbol: 'SBIN', exchange: 'NSE'},
                {symbol: 'KOTAKBANK', exchange: 'NSE'},
                {symbol: 'AXISBANK', exchange: 'NSE'},
                {symbol: 'INDUSINDBK', exchange: 'NSE'},
                {symbol: 'BANDHANBNK', exchange: 'NSE'},
                {symbol: 'FEDERALBNK', exchange: 'NSE'},
                {symbol: 'IDFCFIRSTB', exchange: 'NSE'},
                {symbol: 'PNB', exchange: 'NSE'},
                {symbol: 'BANKBARODA', exchange: 'NSE'},
                {symbol: 'AUBANK', exchange: 'NSE'}
            ]
        },
        'NIFTYIT': {
            name: 'NIFTY IT',
            description: 'Information Technology stocks',
            symbols: [
                {symbol: 'TCS', exchange: 'NSE'},
                {symbol: 'INFY', exchange: 'NSE'},
                {symbol: 'WIPRO', exchange: 'NSE'},
                {symbol: 'HCLTECH', exchange: 'NSE'},
                {symbol: 'TECHM', exchange: 'NSE'},
                {symbol: 'LTIM', exchange: 'NSE'},
                {symbol: 'PERSISTENT', exchange: 'NSE'},
                {symbol: 'COFORGE', exchange: 'NSE'},
                {symbol: 'MPHASIS', exchange: 'NSE'},
                {symbol: 'LTTS', exchange: 'NSE'}
            ]
        },
        'SENSEX': {
            name: 'SENSEX 30',
            description: 'BSE SENSEX 30 stocks',
            symbols: [
                {symbol: 'RELIANCE', exchange: 'BSE'},
                {symbol: 'TCS', exchange: 'BSE'},
                {symbol: 'HDFCBANK', exchange: 'BSE'},
                {symbol: 'ICICIBANK', exchange: 'BSE'},
                {symbol: 'INFY', exchange: 'BSE'},
                {symbol: 'HINDUNILVR', exchange: 'BSE'},
                {symbol: 'ITC', exchange: 'BSE'},
                {symbol: 'SBIN', exchange: 'BSE'},
                {symbol: 'BHARTIARTL', exchange: 'BSE'},
                {symbol: 'KOTAKBANK', exchange: 'BSE'}
            ]
        },
        'MIDCAP': {
            name: 'NIFTY Midcap 100',
            description: 'Mid-cap companies',
            symbols: [
                {symbol: 'JUBLFOOD', exchange: 'NSE'},
                {symbol: 'PAGEIND', exchange: 'NSE'},
                {symbol: 'MUTHOOTFIN', exchange: 'NSE'},
                {symbol: 'VOLTAS', exchange: 'NSE'},
                {symbol: 'GODREJPROP', exchange: 'NSE'},
                {symbol: 'INDHOTEL', exchange: 'NSE'},
                {symbol: 'POLYCAB', exchange: 'NSE'},
                {symbol: 'CONCOR', exchange: 'NSE'},
                {symbol: 'ABFRL', exchange: 'NSE'},
                {symbol: 'CUMMINSIND', exchange: 'NSE'}
            ]
        }
    };

    const list = predefinedLists[indexName];
    if (!list) {
        FluxScan.showToast('Predefined list not found', 'error');
        return;
    }

    try {
        const response = await fetch('/watchlists/api/watchlists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: list.name,
                description: list.description,
                exchange: 'NSE',
                symbols: list.symbols
            })
        });

        if (response.ok) {
            FluxScan.showToast(`${list.name} imported successfully`, 'success');
            importModal.close();
            location.reload();
        } else {
            const error = await response.json();
            FluxScan.showToast(error.error || 'Failed to import predefined list', 'error');
        }
    } catch (error) {
        FluxScan.showToast('Failed to import predefined list', 'error');
    }
}
</script>
{% endblock %}